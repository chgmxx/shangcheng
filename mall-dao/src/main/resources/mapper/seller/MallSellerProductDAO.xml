<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gt.mall.dao.seller.MallSellerProductDAO">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.gt.mall.entity.seller.MallSellerProduct">
        <id column="id" property="id"/>
        <result column="mallset_id" property="mallsetId"/>
        <result column="sale_member_id" property="saleMemberId"/>
        <result column="bus_user_id" property="busUserId"/>
        <result column="product_id" property="productId"/>
        <result column="shop_id" property="shopId"/>
        <result column="is_delete" property="isDelete"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, mallset_id , sale_member_id , bus_user_id , product_id , shop_id , is_delete
    </sql>

    <select id="selectProductByMallSet" resultMap="BaseResultMap" parameterType="com.gt.mall.entity.seller.MallSellerProduct">
        SELECT p.id, p.mallset_id, p.sale_member_id, p.bus_user_id, p.product_id, p.shop_id, p.is_delete
        FROM t_mall_seller_product p
        LEFT JOIN t_mall_seller_join_product jp ON jp.product_id=p.`product_id`
        <where>
            p.is_delete = 0 AND jp.`is_delete`=0
            <if test="id != null">
                and p.mallset_id = #{id}
            </if>
            <if test="saleMemberId != null">
                and p.sale_member_id = #{saleMemberId}
            </if>
        </where>
    </select>

    <select id="selectProductBySaleMember" resultType="Map" parameterType="Map">
        SELECT distinct p.id as id,p.shop_id,sp.id as
        sellerProductId,p.is_member_discount,p.pro_price,p.pro_name,p.is_specifica,d.inv_num,d.inv_price,p.change_integral,p.pro_cost_price,p.change_fenbi,p.pro_label,p.pro_type_id,p.member_type,p.user_id
        FROM t_mall_seller_product sp
        LEFT JOIN t_mall_product p ON p.id=sp.`product_id`
        left join t_mall_seller_join_product jp on jp.product_id=p.id
        LEFT JOIN (SELECT product_id,specifica_img_id,inv_num,inv_price FROM t_mall_product_inventory WHERE is_default=1 AND is_delete=0)d ON p.id=d.product_id
        WHERE sp.`is_delete`=0 AND p.`is_delete`=0 AND p.is_publish=1 AND p.check_status = 1
        AND p.id > 0 and jp.id>0 and jp.is_delete = 0 and jp.is_use = 1
        <if test="mallSetId != null">
            AND sp.`mallset_id`=#{mallSetId}
        </if>
        <if test="saleMemberId != null">
            AND sp.`sale_member_id`= #{saleMemberId}
        </if>
    </select>

    <select id="selectProductByBusUserId" resultType="Map" parameterType="Map">
        SELECT distinct a.id as
        id,a.shop_id,a.is_member_discount,a.pro_price,a.pro_name,a.is_specifica,
        d.inv_num,d.inv_price,a.change_integral,a.pro_cost_price,a.change_fenbi,a.pro_label,a.pro_type_id,a.member_type,
        jp.id as joinProductId,a.user_id
        from t_mall_product a
        left join t_mall_seller_join_product jp on jp.product_id=a.id
        LEFT JOIN (SELECT product_id,specifica_img_id,inv_num,inv_price FROM t_mall_product_inventory where is_default=1 AND is_delete=0)d ON a.id=d.product_id
        WHERE a.is_publish=1 AND a.check_status=1 AND a.is_delete=0 and jp.is_delete=0 and jp.is_use=1 and jp.id > 0
        <if test="busUserId != null">
            and a.user_id = #{busUserId}
        </if>
        <if test="findIds != null">
            and a.id in
            <foreach collection="findIds" index="index" item="item" open="(" separator="," close=")">
                #{item,jdbcType=INTEGER}
            </foreach>
        </if>
        ORDER BY a.id desc
    </select>

    <select id="selectByProIdSale" resultMap="BaseResultMap" parameterType="Map">
        select
        <include refid="Base_Column_List"/>
        from t_mall_seller_product
        where product_id = #{productId} and sale_member_id = #{saleMemberId} and is_delete = 0 limit 1
    </select>

    <select id="selectCountProductAllByMallSet" resultType="java.lang.Integer" parameterType="Map">
        SELECT count(a.id)
        FROM t_mall_seller_product p
        LEFT JOIN t_mall_seller_join_product jp ON jp.product_id=p.`product_id`
        LEFT JOIN t_mall_product a ON a.`id`=p.`product_id`
        <if test="(groupId != null and groupId != '' ) or proName != null and proName != ''">
            LEFT JOIN t_mall_product_group pg ON pg.product_id=a.id AND pg.is_delete=0
            LEFT JOIN t_mall_group g ON g.id=pg.group_id AND g.is_delete=0
        </if>
        <where>
            p.is_delete = 0 AND jp.`is_delete`=0
            <if test="mallSetId != null">
                and p.mallset_id = #{mallSetId}
            </if>
            <if test="saleMemberId != null">
                and p.sale_member_id = #{saleMemberId}
            </if>
            AND a.is_publish=1 AND a.check_status=1 AND a.is_delete=0
            <if test="(groupId != null and groupId != '' ) or proName != null and proName != ''">
                <if test="proName != null and proName != ''">
                    and (a.pro_name like '%${proName}%' or g.group_name like '%${proName}%')
                </if>
                <if test="groupId != null and groupId != ''">
                    and pg.group_id =#{groupId}
                </if>
            </if>
            ORDER BY a.id desc
        </where>
    </select>

    <select id="selectProductAllByMallSet" resultType="Map" parameterType="Map">
        SELECT DISTINCT a.id AS
        id,a.shop_id,a.is_member_discount,a.pro_price,a.pro_name,a.is_specifica,d.inv_num,d.inv_price,a.change_integral,a.pro_cost_price,a.change_fenbi,a.pro_label,a.pro_type_id,a.member_type,a.user_id
        FROM t_mall_seller_product p
        LEFT JOIN t_mall_seller_join_product jp ON jp.product_id=p.`product_id`

        LEFT JOIN t_mall_product a ON a.`id`=p.`product_id`
        LEFT JOIN (SELECT product_id,specifica_img_id,inv_num,inv_price FROM t_mall_product_inventory WHERE is_default=1 AND is_delete=0)d ON a.id=d.product_id
        <if test="(groupId != null and groupId != '' ) or proName != null and proName != ''">
            LEFT JOIN t_mall_product_group pg ON pg.product_id=a.id AND pg.is_delete=0
            LEFT JOIN t_mall_group g ON g.id=pg.group_id AND g.is_delete=0
        </if>
        <where>
            p.is_delete = 0 AND jp.`is_delete`=0
            <if test="mallSetId != null">
                and p.mallset_id = #{mallSetId}
            </if>
            <if test="saleMemberId != null">
                and p.sale_member_id = #{saleMemberId}
            </if>
            AND a.is_publish=1 AND a.check_status=1 AND a.is_delete=0
            <if test="(groupId != null and groupId != '' ) or proName != null and proName != ''">
                <if test="proName != null and proName != ''">
                    and (a.pro_name like '%${proName}%' or g.group_name like '%${proName}%')
                </if>
                <if test="groupId != null and groupId != ''">
                    and pg.group_id =#{groupId}
                </if>
            </if>
            <choose>
                <when test="sort == 'price'">
                    ORDER BY IF(d.inv_price>0 ,d.inv_price,a.pro_price )
                    <if test="isDesc == 1">
                        desc
                    </if>
                </when>
                <when test="sort == 'sale'">
                    ORDER BY a.pro_sale_total+a.sales_base desc
                </when>
                <when test="type == 5">
                    ORDER BY a.change_fenbi desc
                </when>
                <otherwise>
                    ORDER BY a.id desc
                </otherwise>
            </choose>
        </where>
        <if test="firstNum != null and maxNum != null">
            limit #{firstNum},#{maxNum}
        </if>
    </select>


</mapper>

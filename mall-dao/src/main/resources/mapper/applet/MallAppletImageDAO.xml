<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gt.mall.dao.applet.MallAppletImageDAO">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.gt.mall.entity.applet.MallAppletImage">
        <id column="id" property="id"/>
        <result column="image_url" property="imageUrl"/>
        <result column="type" property="type"/>
        <result column="pro_id" property="proId"/>
        <result column="bus_user_id" property="busUserId"/>
        <result column="create_time" property="createTime"/>
        <result column="is_delete" property="isDelete"/>
        <result column="is_show" property="isShow"/>
        <result column="shop_id" property="shopId"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, image_url , type, pro_id , bus_user_id, create_time , is_delete , is_show , shop_id
    </sql>

    <!-- 统计小程序图片-->
    <select id="selectByCount" resultType="java.lang.Integer" parameterType="Map">
        select count(i.id)
        from t_mall_applet_image i where i.is_delete = 0
        <if test="userId != null and userId != ''">
            and i.bus_user_id=#{userId}
        </if>
    </select>
    <!-- 根据拍卖分页 -->
    <select id="selectByPage" resultMap="BaseResultMap" parameterType="Map">
        select
        <include refid="Base_Column_List"/>
        from t_mall_applet_image i
        where i.is_delete = 0
        <if test="userId != null and userId != ''">
            and i.bus_user_id=#{userId}
        </if>
        group by i.id
        order by i.create_time desc
        limit #{firstNum},#{maxNum}
    </select>

    <select id="selectByImage" resultMap="BaseResultMap" parameterType="Map">
        select
        <include refid="Base_Column_List"/>
        from t_mall_applet_image i
        where i.is_delete = 0 and i.is_show = 1
        <if test="userId != null and userId != ''">
            and i.bus_user_id=#{userId}
        </if>
        order by i.create_time desc
    </select>
    <select id="selectAppletImageById"  resultType="Map" parameterType="java.lang.Integer">
    SELECT i.id, i.pro_id AS proId, i.image_url AS imageUrl, i.type, i.bus_user_id AS busUserId,  i.create_time AS createTime,
    i.is_delete AS isDelete, i.is_show AS isShow, c.image_url AS proUrl,e.specifica_img_url AS specImageUrl,p.is_specifica AS isSpecifica,p.pro_name AS proName
    ,IF(p.is_specifica = 0 ,p.pro_price,d.inv_price) AS proPrice ,p.pro_stock_total AS proStockTotal
    FROM t_mall_applet_image i
    LEFT JOIN t_mall_product p ON i.`pro_id` = p.id
    LEFT JOIN (SELECT ass_id,image_url FROM t_mall_image_associative WHERE ass_type=1 AND is_delete=0 AND is_main_images=1) c ON i.pro_id=c.ass_id
    LEFT JOIN (SELECT product_id,specifica_img_id,inv_num,inv_price,id FROM t_mall_product_inventory WHERE is_default=1 AND is_delete=0)d ON i.pro_id=d.product_id
    LEFT JOIN t_mall_product_specifica e ON d.specifica_img_id=e.id
    WHERE i.id = #{id}
    </select>

</mapper>
